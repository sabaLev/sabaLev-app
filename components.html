<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        .row-container {
            display: flex;
            flex-direction: row;
            width: 100%;
            gap: 8px;
            margin-bottom: 12px;
            align-items: center;
        }
        
        .input-column {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* Числовые инпуты */
        .numeric-input {
            display: flex;
            align-items: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            min-height: 44px;
            overflow: hidden;
        }
        
        .numeric-input input {
            flex: 1;
            border: none;
            text-align: center;
            padding: 10px 4px;
            font-size: 16px;
            min-width: 0;
            width: 100%;
            outline: none;
        }
        
        .numeric-btn {
            background: #f0f0f0;
            border: none;
            padding: 10px 12px;
            cursor: pointer;
            font-size: 16px;
            color: #333;
            min-width: 40px;
        }
        
        .numeric-btn:hover {
            background: #e0e0e0;
        }
        
        .numeric-btn:active {
            background: #d0d0d0;
        }
        
        /* Селект */
        .select-input {
            width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
            background: white;
            min-height: 44px;
            padding: 10px 8px;
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Заголовки */
        .column-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            text-align: center;
            font-weight: 500;
        }
        
        /* Мобильная адаптация */
        @media (max-width: 768px) {
            .row-container {
                gap: 4px;
            }
            
            .numeric-input input {
                padding: 10px 2px;
                font-size: 15px;
                min-width: 40px;
                max-width: 60px;
            }
            
            .numeric-btn {
                padding: 10px 8px;
                min-width: 36px;
            }
            
            .select-input {
                padding: 10px 4px;
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div id="rows-container"></div>

    <script>
        // Данные для каждой строки
        const rowData = [];
        
        // Создание одной строки
        function createRow(index) {
            const rowDiv = document.createElement('div');
            rowDiv.className = 'row-container';
            rowDiv.id = `row-${index}`;
            
            // Колонка 1: שורות (ряды)
            const col1 = document.createElement('div');
            col1.className = 'input-column';
            col1.innerHTML = `
                <div class="column-label">שורות</div>
                <div class="numeric-input">
                    <button class="numeric-btn minus-btn" data-field="g">-</button>
                    <input type="number" id="g_${index}" value="0" min="0" max="99" step="1">
                    <button class="numeric-btn plus-btn" data-field="g">+</button>
                </div>
            `;
            
            // Колонка 2: פאנלים (панели)
            const col2 = document.createElement('div');
            col2.className = 'input-column';
            col2.innerHTML = `
                <div class="column-label">פאנלים</div>
                <div class="numeric-input">
                    <button class="numeric-btn minus-btn" data-field="n">-</button>
                    <input type="number" id="n_${index}" value="0" min="0" max="99" step="1">
                    <button class="numeric-btn plus-btn" data-field="n">+</button>
                </div>
            `;
            
            // Колонка 3: כיוון (направление)
            const col3 = document.createElement('div');
            col3.className = 'input-column';
            col3.innerHTML = `
                <div class="column-label">כיוון</div>
                <select class="select-input" id="o_${index}">
                    <option value="עומד">עומד</option>
                    <option value="שוכב">שוכב</option>
                </select>
            `;
            
            rowDiv.appendChild(col1);
            rowDiv.appendChild(col2);
            rowDiv.appendChild(col3);
            
            return rowDiv;
        }
        
        // Отправка данных в Streamlit
        function sendDataToStreamlit() {
            const data = [];
            
            for (let i = 0; i < rowData.length; i++) {
                const g = parseInt(document.getElementById(`g_${i}`).value) || 0;
                const n = parseInt(document.getElementById(`n_${i}`).value) || 0;
                const o = document.getElementById(`o_${i}`).value;
                
                if (g > 0 && n > 0) {
                    data.push({index: i, g, n, o});
                }
            }
            
            window.parent.postMessage({
                type: 'streamlit:setComponentValue',
                value: data
            }, '*');
        }
        
        // Обработчики кнопок +/-
        function setupNumericButtons(rowIndex) {
            const row = document.getElementById(`row-${rowIndex}`);
            
            row.querySelectorAll('.numeric-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const field = this.getAttribute('data-field');
                    const input = document.getElementById(`${field}_${rowIndex}`);
                    let value = parseInt(input.value) || 0;
                    
                    if (this.classList.contains('plus-btn')) {
                        value = Math.min(value + 1, 99);
                    } else {
                        value = Math.max(value - 1, 0);
                    }
                    
                    input.value = value;
                    sendDataToStreamlit();
                });
            });
            
            // Обработчики прямого ввода
            row.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', function() {
                    let value = parseInt(this.value) || 0;
                    if (value > 99) {
                        value = 99;
                        this.value = 99;
                    }
                    sendDataToStreamlit();
                });
            });
            
            // Обработчик селекта
            row.querySelector('select').addEventListener('change', sendDataToStreamlit);
        }
        
        // Инициализация
        function initializeRows(count) {
            const container = document.getElementById('rows-container');
            container.innerHTML = '';
            rowData.length = 0;
            
            for (let i = 0; i < count; i++) {
                rowData.push({g: 0, n: 0, o: 'עומד'});
                const row = createRow(i);
                container.appendChild(row);
                setupNumericButtons(i);
                
                // Устанавливаем значения по умолчанию
                if (i < 8) {
                    document.getElementById(`n_${i}`).value = i + 1;
                    document.getElementById(`g_${i}`).value = 1;
                } else if (i < 12) {
                    document.getElementById(`n_${i}`).value = i - 7;
                    document.getElementById(`o_${i}`).value = 'שוכב';
                    document.getElementById(`g_${i}`).value = 1;
                }
            }
            
            sendDataToStreamlit();
        }
        
        // Получение команд от Streamlit
        window.addEventListener('message', (event) => {
            if (event.data.type === 'streamlit:setComponentValue') {
                if (event.data.action === 'initialize') {
                    initializeRows(event.data.rows || 12);
                } else if (event.data.action === 'addRow') {
                    initializeRows(rowData.length + 1);
                }
            }
        });
        
        // Инициализация по умолчанию
        initializeRows(12);
        
        // Сообщаем о готовности
        setTimeout(() => {
            window.parent.postMessage({
                type: 'streamlit:componentReady',
                value: true
            }, '*');
        }, 100);
    </script>
</body>
</html>
